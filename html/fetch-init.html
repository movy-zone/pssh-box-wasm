<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fetch PSSH data</title>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/picocss/2.0.0/pico.classless.amber.min.css"
      integrity="sha512-eoG3B3AJGSRXIEn/4X2/QrbAXRM1Bp+JNA4QKVdLAwno9AOv56TZo07rojZK4NHiMigWAMFM2YkZv986MsGwkg=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="data:,">
  </head>
  <body>
    <main>
      <noscript>
        <article style="backgroundColor:#F08080">
          This site's functionality is implemented in WebAssembly, and requires Javascript.
        </article>
      </noscript>
    <nav>
      <ul>
        <li><h1>Fetch PSSH data</h1></li>
        <li><img src="img/beta.svg" style="width:2em;vertical-align:top">
      </ul>
      <ul>
        <li><a href="decode.html">Decode PSSH</a></li> |
        <li><img src="img/anvil.svg" style="width:1em"> <a href="generate.html">Generate Widevine PSSH</a></li>
      </ul>
    </nav>
     <form>
       <fieldset role="group">
         <input id="url" type="url" placeholder="https://server.com/init.mp4"/>
         <button id="go"
            data-tooltip="Fetch MP4 segment and decode any PSSH boxes"
            data-placement="left">Fetch</button>
       </fieldset>
       <small>The URL of the initialization segment to fetch</small>
     </form>

    <div id="output" style="margin-top:2em;padding:1em"></div>

    <p style="margin-top:2em">This tool fetches an initialization segment from a web server (an MP4
    fragment), extracts any DRM initialization data (PSSH boxes) and decodes them. Here is a
    <a href="https://m.dtv.fi/dash/dasherh264v3/drm/a1/i.mp4">sample URL</a> for testing.

    <p><strong>Privacy</strong>: this tool is implemented in WebAssembly and runs locally in your
    web browser. Once loaded, it will run fully offline.

    </main>

    <hr>
    <footer style="font-size:small;display:flex;justify-content:space-between">
    <span>Version: <span id="version"></span></span>
    <span><img src="img/github.svg" style="width:2em;vertical-align:bottom">
      <a href="https://github.com/emarsden/pssh-box-wasm/">GitHub repository</a></span>
    <span>WebAssembly <img src="img/webassembly.svg" style="width:2em;vertical-align:bottom"> made with Rust
      <img src="img/rustacean.svg" style="width:2em;vertical-align:bottom"></span>
    </footer>

    <script type="module">
    import init, { fetch_pssh_data, code_version } from "./pkg/pssh_box_wasm.js";
      init().then(() => {
        document.getElementById("version").innerHTML = code_version();
      });

      document.getElementById("go").addEventListener("click", function(e) {
          e.preventDefault();
          e.target.style.cursor = "wait";
          let out = document.getElementById("output");
          let url = document.getElementById("url").value.trim();
          fetch_pssh_data(url)
          .then((html) => {
             out.innerHTML = "<strong>PSSH data</strong><br>" + html;
             out.style.backgroundColor = "#CCC";
            })
            .catch((e) => {
               out.innerHTML = "<img src='img/error.svg' style='width:1em'>&nbsp;" +
                e.toString()
                .replace("Error:", "<strong>Error</strong>:")
                .replace("\n", "<br>");
               out.style.backgroundColor = "rgba(250, 10, 10, 0.2)";
            });
          e.target.style.cursor = "auto";
      });
    </script>
   </body>
</html>
